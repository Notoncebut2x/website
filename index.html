<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Rory Nealon's personal website featuring maps of bike rides, bird sightings, and life experiences">
    <meta name="keywords" content="Rory Nealon, maps, biking, birding, geography, data visualization">
    <meta name="author" content="Rory Nealon">
    <meta property="og:title" content="Rory Nealon">
    <meta property="og:description" content="Explore my life through maps of bike rides, bird sightings, and experiences">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rorynealon.com">
    <meta property="og:image" content="https://rorynealon.com/images/og-image.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Rory Nealon">
    <meta name="twitter:description" content="Explore my life through maps of bike rides, bird sightings, and experiences">
    <meta name="twitter:image" content="https://rorynealon.com/images/og-image.jpg">
    <title>Rory Nealon</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v4.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            height: 100vh;
            background-color: #000000;
            overflow: hidden;
        }

        /* Loading indicator */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #loading-overlay.visible {
            opacity: 1;
        }

        #loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff00ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }

        /* Error message */
        #error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 5px;
            z-index: 9999;
            display: none;
            text-align: center;
        }

        .container-fluid {
            height: 100%;
            padding: 0;
        }

        .row {
            height: 100%;
            margin: 0;
        }

        .sidebar {
            height: 100vh;
            padding: 2rem;
            padding-left: 4rem;
            display: flex;
            flex-direction: column;
            background-color: #000000;
            color: #ffffff;
            position: fixed;
            width: 25%;
            max-width: 400px;
            z-index: 1000;
        }

        h1 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 500;
            margin-bottom: 4rem;
            letter-spacing: 0.05em;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
        }

        .nav-link {
            color: #ffffff;
            text-decoration: none;
            font-size: clamp(1rem, 2vw, 1.25rem);
            font-weight: 400;
            opacity: 0.8;
            transition: opacity 0.3s ease;
            line-height: 1;
            position: relative;
            z-index: 1;
            margin-bottom: 0;
        }

        .nav-link:hover {
            opacity: 1;
        }

        .content-section {
            display: block;
            color: #ffffff;
            font-size: clamp(0.875rem, 1.5vw, 1rem);
            line-height: 1.6;
            max-width: 100%;
            padding-left: 0.5rem;
            height: 0;
            margin: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease-out,
                        transform 0.3s ease-out,
                        height 0.3s ease-out;
            position: relative;
            pointer-events: none;
            background-color: #000000;
        }

        .content-section.active {
            opacity: 1;
            height: auto;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
            transform: translateY(0);
            pointer-events: auto;
        }

        #bio-content h3 {
            font-size: clamp(1.25rem, 2vw, 1.5rem);
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .bio-date {
            font-size: 0.9rem;
            color: #808080;
            margin-bottom: 1rem;
        }

        .bio-details {
            margin-bottom: 15px;
            font-size: 0.9rem;
            padding-left: 0.25rem;
        }
        
        .bio-filter-container {
            margin-bottom: 10px;
            display: none; /* Hidden by default, shown when bio section is active */
        }
        
        .bio-filter-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            padding-left: 0.25rem;
        }
        
        .bio-filter-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-family: 'Quicksand', sans-serif;
            font-size: clamp(0.925rem, 1.25vw, 1rem);
            font-weight: 400;
            opacity: 0.8;
            cursor: pointer;
            padding: 0;
            transition: opacity 0.3s ease;
        }
        
        .bio-filter-btn:hover {
            opacity: 1;
        }
        
        .bio-filter-btn.active {
            opacity: 1;
            font-weight: 500;
        }
        
        .bio-filter-separator {
            color: #ffffff;
            opacity: 0.8;
            font-size: clamp(0.925rem, 1.25vw, 1rem);
        }

        /* Bike filter styles */
        #bike .bio-filter-container {
            margin-bottom: 10px;
            display: none; /* Hidden by default, shown when bike section is active */
        }
        
        #bike .bio-filter-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            padding-left: 0.25rem;
        }
        
        #bike .bio-filter-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-family: 'Quicksand', sans-serif;
            font-size: clamp(0.925rem, 1.25vw, 1rem);
            font-weight: 400;
            opacity: 0.8;
            cursor: pointer;
            padding: 0;
            transition: opacity 0.3s ease;
        }
        
        #bike .bio-filter-btn:hover {
            opacity: 1;
        }
        
        #bike .bio-filter-btn.active {
            opacity: 1;
            font-weight: 500;
        }
        
        #bike .bio-filter-separator {
            color: #ffffff;
            opacity: 0.8;
            font-size: clamp(0.925rem, 1.25vw, 1rem);
        }

        #map-container {
            height: 100vh;
            background-color: #000000;
            overflow: hidden;
            margin-left: 25%;
            width: 75%;
        }

        .sphere {
            fill: #000000;
            stroke: #808080;
            stroke-width: 0.5;
            opacity: 0.3;
        }

        .earth {
            fill: #808080;  /* Gray for inactive squares */
            stroke: #2c3e50;
            stroke-width: 0.5;
            opacity: 0.8;
            transition: fill 0.3s ease;
        }

        .earth.highlighted {
            fill: #ff00ff;
        }

        .earth.bio-heat {
            opacity: 0.8;
            transition: fill 0.3s ease;
        }

        .earth.bio-heat.highlighted {
            fill: #ff00ff;
        }

        .earth.bird-heat {
            opacity: 0.8;
            transition: fill 0.3s ease;
        }

        .earth.bird-heat.zero {
            fill: #808080;  /* Gray for 0 species */
        }

        .earth.bird-heat.low {
            fill: #ff9999;  /* Light red for 1-15 species */
        }

        .earth.bird-heat.medium {
            fill: #ff4444;  /* Medium red for 16-55 species */
        }

        .earth.bird-heat.high {
            fill: #cc0000;  /* Dark red for 56+ species */
        }

        .earth.bike-heat {
            opacity: 0.8;
            transition: fill 0.3s ease;
        }

        .earth.bike-heat.inactive {
            fill: #808080;  /* Gray for no biking */
        }

        .earth.bike-heat.active {
            fill: #ff4444;  /* Red for biking activity */
        }

        .earth.bike-heat.highlighted {
            fill: #ff00ff;
        }

        /* Bike heat map categories */
        .earth.bike-heat.low {
            fill: #ff9999;  /* Light red for low elevation/distance */
        }

        .earth.bike-heat.medium {
            fill: #ff4444;  /* Medium red for medium elevation/distance */
        }

        .earth.bike-heat.high {
            fill: #cc0000;  /* Dark red for high elevation/distance */
        }

        .tooltip {
            position: fixed;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            max-width: 300px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            font-weight: 500;
        }

        .tooltip .date {
            color: #ccc;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .tooltip .details {
            font-size: 13px;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                width: 100%;
                max-width: none;
                height: auto;
                padding: 1rem;
                padding-left: 2rem;
                background-color: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(5px);
            }

            #map-container {
                margin-left: 0;
                width: 100%;
                height: calc(100vh - 80px);
                margin-top: 80px;
            }

            .content-section {
                padding-left: 0;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                padding: 0.75rem;
                padding-left: 1.5rem;
            }

            h1 {
                margin-bottom: 2rem;
            }

            .nav-links {
                gap: 1rem;
            }

            #map-container {
                height: calc(100vh - 60px);
                margin-top: 60px;
            }
        }

        .bio-heat.highlighted,
        .bio-heat.active {
            fill: #4CAF50;  /* Green for bio entries */
            opacity: 1;
        }

        .bio-heat {
            transition: fill 0.3s ease, opacity 0.3s ease;
        }

        /* Ensure bio section is visible when active */
        #bio.content-section.active {
            display: block;
            opacity: 1;
            height: auto;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Style for bio section content */
        #bio-content {
            color: #ffffff;
            font-size: clamp(0.875rem, 1.5vw, 1rem);
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loading-overlay">
        <div id="loading-spinner"></div>
        <div id="loading-text">Loading map data...</div>
    </div>
    
    <!-- Error message -->
    <div id="error-message"></div>
    
    <div class="container-fluid h-100">
        <div class="row h-100 align-items-start">
            <div class="col-md-3 sidebar">
                <h1>Rory Nealon</h1>
                <nav class="nav-links">
                    <a href="#" class="nav-link" data-section="bio">Bio</a>
                    <div id="bio" class="content-section">
                        <div id="bio-content">
                            <div class="bio-filter-container">
                                <div class="bio-filter-buttons">
                                    <button class="bio-filter-btn active" data-category="all">All</button>
                                    <span class="bio-filter-separator">|</span>
                                    <button class="bio-filter-btn" data-category="professional">Professional</button>
                                    <span class="bio-filter-separator">|</span>
                                    <button class="bio-filter-btn" data-category="personal">Personal</button>
                                </div>
                            </div>
                            <p class="bio-details">Learn about where I have lived, worked and gone to school. Hover over each highlighted portion of the map to learn more.</p>
                        </div>
                    </div>
                    <a href="#" class="nav-link" data-section="birds">Birds</a>
                    <div id="birds" class="content-section">
                        <div class="map-container">
                            <div id="birds-content">
                                <p class="bio-details">Hover over grid squares to see the number of species observed. If you want to see more updated info and checklists, check out my <a href="https://ebird.org/profile/NDk4NDUz/world" target="_blank">ebird profile</a>.</p>
                            </div>
                        </div>
                    </div>
                    <a href="#" class="nav-link" data-section="bike">Bikes</a>
                    <div id="bike" class="content-section">
                        <div class="map-container">
                            <div id="bike-content">
                                <div class="bio-filter-container">
                                    <div class="bio-filter-buttons">
                                        <button class="bio-filter-btn" data-category="ride">Rides</button>
                                        <span class="bio-filter-separator">|</span>
                                        <button class="bio-filter-btn" data-category="elevation">Elevation</button>
                                        <span class="bio-filter-separator">|</span>
                                        <button class="bio-filter-btn" data-category="distance">Distance</button>
                                    </div>
                                </div>
                                <p class="bio-details">I love to bike! See where I have biked on the map and see how many miles I have biked in each grid cell by clicking on the map. For more details check out my <a href="https://www.strava.com/athletes/4755914" target="_blank">Strava profile</a>.</p>
                            </div>
                        </div>
                    </div>
                    <a href="#" class="nav-link" data-section="beers">Beers</a>
                    <div id="beers" class="content-section">
                        <div id="beers-content">
                            <p class="bio-details"> More comming soon!!! I have been homebrewing since I was in high school, no seriously we brewed beer in chemistry class and had to get waivers from our parents. Since then I have only brewed one beer that tasted like cheese!</p>
                        </div>
                    </div>
                    <a href="#" class="nav-link" data-section="bearings">Bearings</a>
                    <div id="bearings" class="content-section">
                        <div id="bearings-content">
                            <p class="bio-details">Having lived around the world I get my bearings with maps. Whether I'm biking, birding, or wondering where a style of beer I just drank came from originally. I decided to make a career out of understanding location and its impact on our natural and built environment, society and our lives.</p>
                        </div>
                    </div>
                    <a href="#" class="nav-link" data-section="buddies">Buddies</a>
                    <div id="buddies" class="content-section">
                        <div id="buddies-content">
                            <p class="bio-details">Check out my dad's <a href="https://jamesdnealon.substack.com/" target="_blank">Substack</a> for his thoughts on geo-political events and growing up.</p>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="col-md-9" id="map-container"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Tooltip div -->
    <div class="tooltip"></div>
    <script>
        // Global variables
        let bikeData = null;
        let birdData = null;
        let bioData = null;
        let earthData = null;
        let tooltip = null;  // Add tooltip as a global variable
        let dataLoadCount = 0;
        const totalDataFiles = 4;

        // Show loading indicator
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('visible');
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('visible');
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Check if all data is loaded
        function checkAllDataLoaded() {
            dataLoadCount++;
            if (dataLoadCount === totalDataFiles) {
                hideLoading();
                
                if (bioData) {
                    const bioSection = document.getElementById('bio');
                    if (bioSection && bioSection.classList.contains('active')) {
                        handleNavClick.call(document.querySelector('.nav-link[data-section="bio"]'));
                    }
                }
            }
        }

        // Map configuration
        const config = {
            scale: 200,
            position: {
                x: window.innerWidth * 0.38,
                y: window.innerHeight * 0.45
            }
        };

        // Initialize map
        const svg = d3.select("#map-container")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("preserveAspectRatio", "xMidYMid meet");

        // Create projection
        const projection = d3.geoNaturalEarth1()
            .scale(config.scale)
            .translate([config.position.x, config.position.y]);

        const path = d3.geoPath().projection(projection);

        // Function to validate coordinates
        function validateCoordinates(coords) {
            return coords.map(coord => [
                Math.max(-180, Math.min(180, coord[0])),
                Math.max(-90, Math.min(90, coord[1]))
            ]);
        }

        // Process feature data
        function processFeatures(features) {
            return features.map(feature => {
                if (feature.geometry.type === "MultiPolygon") {
                    return {
                        ...feature,
                        geometry: {
                            ...feature.geometry,
                            coordinates: feature.geometry.coordinates.map(polygon =>
                                polygon.map(ring => validateCoordinates(ring))
                            )
                        }
                    };
                }
                return feature;
            });
        }

        // Initialize map elements
        function initializeMap(data) {
            // Add sphere/graticule
            svg.append("path")
                .datum(d3.geoGraticule()
                    .extent([[-180, -90], [190, 90]])
                    .step([10, 10]))
                .attr("class", "sphere")
                .attr("d", path);

            // Add extra line at 100¬∞
            svg.append("path")
                .datum(d3.geoGraticule()
                    .extent([[-180, 100], [190, 100]])
                    .step([10, 10]))
                .attr("class", "sphere")
                .attr("d", path);

            // Initialize tooltip
            tooltip = d3.select(".tooltip");

            // Process and add earth features
            const features = processFeatures(data.features);
            svg.append("g")
                .selectAll("path")
                .data(features)
                .join("path")
                .attr("class", "earth")
                .attr("data-id", d => d.properties.fid)
                .attr("d", path);
        }

        // Handle navigation clicks
        function handleNavClick(e) {
            e.preventDefault();
            const sectionId = this.getAttribute('data-section');
            if (!sectionId) return;

            document.querySelectorAll('.content-section').forEach(section => {
                if (section.id !== sectionId) {
                    section.classList.remove('active');
                }
            });

            const section = document.getElementById(sectionId);
            const isActive = section.classList.toggle('active');
            
            // Reset all map classes first
            svg.selectAll('.earth')
                .classed('bird-heat', false)
                .classed('bike-heat', false)
                .classed('bio-heat', false)
                .classed('highlighted', false)
                .classed('zero', false)
                .classed('low', false)
                .classed('medium', false)
                .classed('high', false)
                .classed('inactive', false)
                .classed('active', false);
            
            // Handle map highlighting
            if (sectionId === 'bio' && bioData) {
                // Show the filter dropdown
                d3.select('#bio .bio-filter-container').style('display', 'block');
                
                // Toggle bio heat map
                svg.selectAll('.earth')
                    .classed('bio-heat', isActive)
                    .style('opacity', isActive ? 1 : 0.3);
                
                if (isActive) {
                    // Initialize map with "All" entries highlighted
                    svg.selectAll('.earth').each(function(d) {
                        if (!d || !d.properties) return;
                        
                        const earthFid = String(d.properties.fid);
                        const allEntries = bioData.features.filter(f => String(f.fid) === earthFid);
                        
                        if (allEntries.length > 0) {
                            d3.select(this)
                                .classed('highlighted', true)
                                .classed('active', true);
                        }
                    });
                    
                    // Add event listener for the filter buttons
                    d3.selectAll('#bio .bio-filter-btn').on('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        d3.selectAll('#bio .bio-filter-btn').classed('active', false);
                        d3.select(this).classed('active', true);
                        
                        const selectedCategory = d3.select(this).attr('data-category');
                        
                        svg.selectAll('.earth').each(function(d) {
                            if (!d || !d.properties) return;
                            
                            const earthFid = String(d.properties.fid);
                            const allEntries = bioData.features.filter(f => String(f.fid) === earthFid);
                            const filteredEntries = selectedCategory === 'all' 
                                ? allEntries 
                                : allEntries.filter(entry => entry.category === selectedCategory);
                            
                            d3.select(this)
                                .classed('highlighted', filteredEntries.length > 0)
                                .classed('active', filteredEntries.length > 0);
                        });
                    });
                    
                    // Add event handlers for bio features
                    svg.selectAll('.earth')
                        .on('mouseover', function(event, d) {
                            if (!d || !d.properties) return;
                            
                            const earthFid = String(d.properties.fid);
                            const allEntries = bioData.features.filter(f => String(f.fid) === earthFid);
                            
                            if (allEntries.length > 0 && tooltip) {
                                const selectedCategory = d3.select('#bio .bio-filter-btn.active').attr('data-category');
                                const filteredEntries = selectedCategory === 'all' 
                                    ? allEntries 
                                    : allEntries.filter(entry => entry.category === selectedCategory);
                                
                                if (filteredEntries.length > 0) {
                                    let tooltipContent = `<h4>${filteredEntries[0].title}</h4>`;
                                    
                                    filteredEntries.forEach(entry => {
                                        tooltipContent += `
                                            <div class="details">
                                                <strong>${entry.startDate} - ${entry.endDate}</strong><br>
                                                ${entry.details}
                                            </div>
                                        `;
                                    });
                                    
                                    tooltip.html(tooltipContent)
                                        .style('left', (event.pageX + 10) + 'px')
                                        .style('top', (event.pageY - 10) + 'px')
                                        .transition()
                                        .duration(200)
                                        .style('opacity', 1);
                                }
                            }
                        })
                        .on('mousemove', function(event) {
                            if (tooltip) {
                                tooltip.style('left', (event.pageX + 10) + 'px')
                                    .style('top', (event.pageY - 10) + 'px');
                            }
                        })
                        .on('mouseout', function() {
                            if (tooltip) {
                                tooltip.transition()
                                    .duration(500)
                                    .style('opacity', 0);
                            }
                        });
                } else {
                    d3.select('#bio .bio-filter-container').style('display', 'none');
                    svg.selectAll('.earth')
                        .on('mouseover', null)
                        .on('mousemove', null)
                        .on('mouseout', null);
                    d3.selectAll('#bio .bio-filter-btn')
                        .on('click', null);
                }
            } else if (sectionId === 'birds' && birdData) {
                svg.selectAll('.earth')
                    .classed('bird-heat', isActive)
                    .classed('highlighted', false);

                if (isActive) {
                    // Show zero species first
                    svg.selectAll('.earth')
                        .each(function(d) {
                            const birdFeature = birdData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                            if (birdFeature && birdFeature.properties.species_count === 0) {
                                d3.select(this).classed('zero', true);
                            }
                        });

                    // Show low density
                    svg.selectAll('.earth')
                        .each(function(d) {
                            const birdFeature = birdData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                            if (birdFeature) {
                                const count = birdFeature.properties.species_count;
                                if (count > 0 && count <= 15) {
                                    d3.select(this)
                                        .classed('zero', false)
                                        .classed('low', true);
                                }
                            }
                        });

                    // Show medium density
                    svg.selectAll('.earth')
                        .each(function(d) {
                            const birdFeature = birdData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                            if (birdFeature) {
                                const count = birdFeature.properties.species_count;
                                if (count > 15 && count <= 55) {
                                    d3.select(this)
                                        .classed('low', false)
                                        .classed('medium', true);
                                }
                            }
                        });

                    // Show high density
                    svg.selectAll('.earth')
                        .each(function(d) {
                            const birdFeature = birdData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                            if (birdFeature) {
                                const count = birdFeature.properties.species_count;
                                if (count > 55) {
                                    d3.select(this)
                                        .classed('medium', false)
                                        .classed('high', true);
                                }
                            }
                        });

                    // Add tooltip events
                    svg.selectAll('.earth')
                        .on('mouseover', function(event, d) {
                            const birdFeature = birdData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                            if (birdFeature && tooltip) {
                                d3.select(this).classed('highlighted', true);
                                tooltip.html(`
                                    <h4>Bird Sightings</h4>
                                    <div class="details">${birdFeature.properties.species_count} species observed</div>
                                `)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px')
                                .transition()
                                .duration(200)
                                .style('opacity', 1);
                            }
                        })
                        .on('mousemove', function(event) {
                            if (tooltip) {
                                tooltip.style('left', (event.pageX + 10) + 'px')
                                    .style('top', (event.pageY - 10) + 'px');
                            }
                        })
                        .on('mouseout', function() {
                            if (tooltip) {
                                d3.select(this).classed('highlighted', false);
                                tooltip.transition()
                                    .duration(500)
                                    .style('opacity', 0);
                            }
                        });
                }
            } else if (sectionId === 'bike' && bikeData) {
                svg.selectAll('.earth')
                    .classed('bike-heat', isActive)
                    .classed('highlighted', false);

                if (isActive) {
                    d3.select('#bike .bio-filter-container').style('display', 'block');
                    
                    svg.selectAll('.earth')
                        .each(function(d) {
                            const bikeFeature = bikeData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                            if (bikeFeature) {
                                d3.select(this).classed('active', true);
                            }
                        });

                    d3.selectAll('#bike .bio-filter-btn').on('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        d3.selectAll('#bike .bio-filter-btn').classed('active', false);
                        d3.select(this).classed('active', true);
                        
                        const selectedCategory = d3.select(this).attr('data-category');
                        
                        svg.selectAll('.earth')
                            .classed('active', false)
                            .classed('low', false)
                            .classed('medium', false)
                            .classed('high', false);
                        
                        if (selectedCategory === 'ride' || selectedCategory === 'all') {
                            svg.selectAll('.earth')
                                .each(function(d) {
                                    const bikeFeature = bikeData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                                    if (bikeFeature) {
                                        d3.select(this).classed('active', true);
                                    }
                                });
                        } else if (selectedCategory === 'elevation') {
                            svg.selectAll('.earth')
                                .each(function(d) {
                                    const bikeFeature = bikeData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                                    if (bikeFeature) {
                                        const elevation = bikeFeature.properties.elevation_gain;
                                        if (elevation > 0) {
                                            if (elevation <= 100) {
                                                d3.select(this).classed('low', true);
                                            } else if (elevation <= 500) {
                                                d3.select(this).classed('medium', true);
                                            } else {
                                                d3.select(this).classed('high', true);
                                            }
                                        }
                                    }
                                });
                        } else if (selectedCategory === 'distance') {
                            svg.selectAll('.earth')
                                .each(function(d) {
                                    const bikeFeature = bikeData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                                    if (bikeFeature) {
                                        const distance = bikeFeature.properties.distance;
                                        if (distance > 0) {
                                            if (distance <= 10) {
                                                d3.select(this).classed('low', true);
                                            } else if (distance <= 50) {
                                                d3.select(this).classed('medium', true);
                                            } else {
                                                d3.select(this).classed('high', true);
                                            }
                                        }
                                    }
                                });
                        }
                    });

                    svg.selectAll('.earth')
                        .on('mouseover', function(event, d) {
                            const bikeFeature = bikeData.features.find(f => String(f.properties.fid) === String(d.properties.fid));
                            if (bikeFeature && tooltip) {
                                d3.select(this).classed('highlighted', true);
                                
                                const selectedCategory = d3.select('#bike .bio-filter-btn.active').attr('data-category');
                                let tooltipContent = `<h4>I biked here!</h4>`;
                                
                                if (selectedCategory === 'ride') {
                                    tooltipContent += `
                                        <div class="details">${(bikeFeature.properties.distance * 0.621371).toFixed(1)} miles</div>
                                        <div class="details">Elevation gain: ${(bikeFeature.properties.elevation_gain * 3.28084).toFixed(0)} feet</div>
                                        <div class="details">${bikeFeature.properties.files.length} rides</div>
                                    `;
                                } else if (selectedCategory === 'elevation') {
                                    const elevation = bikeFeature.properties.elevation_gain;
                                    let elevationLevel = "Low";
                                    if (elevation > 500) {
                                        elevationLevel = "High";
                                    } else if (elevation > 100) {
                                        elevationLevel = "Medium";
                                    }
                                    tooltipContent += `
                                        <div class="details">Elevation: ${elevationLevel}</div>
                                        <div class="details">Elevation gain: ${(bikeFeature.properties.elevation_gain * 3.28084).toFixed(0)} feet</div>
                                    `;
                                } else if (selectedCategory === 'distance') {
                                    const distance = bikeFeature.properties.distance;
                                    let distanceLevel = "Low";
                                    if (distance > 50) {
                                        distanceLevel = "High";
                                    } else if (distance > 10) {
                                        distanceLevel = "Medium";
                                    }
                                    tooltipContent += `
                                        <div class="details">Distance: ${distanceLevel}</div>
                                        <div class="details">${(bikeFeature.properties.distance * 0.621371).toFixed(1)} miles</div>
                                    `;
                                }
                                
                                tooltip.html(tooltipContent)
                                    .style('left', (event.pageX + 10) + 'px')
                                    .style('top', (event.pageY - 10) + 'px')
                                    .transition()
                                    .duration(200)
                                    .style('opacity', 1);
                            }
                        })
                        .on('mousemove', function(event) {
                            if (tooltip) {
                                tooltip.style('left', (event.pageX + 10) + 'px')
                                    .style('top', (event.pageY - 10) + 'px');
                            }
                        })
                        .on('mouseout', function() {
                            if (tooltip) {
                                d3.select(this).classed('highlighted', false);
                                tooltip.transition()
                                    .duration(500)
                                    .style('opacity', 0);
                            }
                        });
                } else {
                    d3.select('#bike .bio-filter-container').style('display', 'none');
                    svg.selectAll('.earth')
                        .on('mouseover', null)
                        .on('mousemove', null)
                        .on('mouseout', null);
                    d3.selectAll('#bike .bio-filter-btn')
                        .on('click', null);
                }
            }
        }

        // Load data
        showLoading();
        
        d3.json('./data/map_data/earth_bikes.geojson').then(data => {
            bikeData = data;
            checkAllDataLoaded();
        }).catch(error => {
            console.error('Error loading bike data:', error);
            showError('Failed to load bike data. Please refresh the page.');
            checkAllDataLoaded();
        });

        d3.json('./data/map_data/earth_birds.geojson').then(data => {
            birdData = data;
            checkAllDataLoaded();
        }).catch(error => {
            console.error("Error loading bird data:", error);
            showError('Failed to load bird data. Please refresh the page.');
            checkAllDataLoaded();
        });

        d3.json('./data/map_data/bio.json').then(data => {
            bioData = data;
            checkAllDataLoaded();
        }).catch(error => {
            console.error("Error loading bio data:", error);
            showError('Failed to load bio data. Please refresh the page.');
            checkAllDataLoaded();
        });

        d3.json('./data/map_data/earth.geojson').then(data => {
            earthData = data;
            initializeMap(data);
            checkAllDataLoaded();
        }).catch(error => {
            console.error("Error loading earth data:", error);
            showError('Failed to load map data. Please refresh the page.');
            checkAllDataLoaded();
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', handleNavClick);
        });
    </script>
</body>
</html>
